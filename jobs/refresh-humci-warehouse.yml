# Each iteration uses the same partition num and site name in order to ensure data is not duplicated across
# multiple partitions if the same table is defined in multiple nested jobs (eg. lab and tb jobs)
# This will result in the same ETLs running multiple times unnecessarily, but this is fine in a test environment
# in the HUMCI run, all of the tables are specified here but in a produciton environment, child jobs will be called for HIV, non-HIV etc...

type: "job-pipeline"
description: "Refreshing HUMCI data"
schedule:
  cron: "${executeCron.refreshHumciWarehouse}"
configuration:
  jobs:
    - path: "create-source-views-and-functions.yml"
    - type: "iterating-job"
      siteName: "humci"
      partitionNum: "1"
      description: "Importing from ${siteName} using partition ${partitionNum}"
      configuration:
        maxConcurrentJobs: 1 # Import into up to 1 tables concurrently
        jobTemplate:
          path: "import-to-table-partition.yml"
        iterations:
          - tableName: "all_lab_orders"
          - tableName: "all_lab_results"
          - tableName: "all_vitals"
          - tableName: "all_encounters_staging" 
#         - tableName: "all_visits"          
          - tableName: "eid_visit"
          - tableName: "hiv_dispensing"
          - tableName: "hiv_patient"
          - tableName: "hiv_patient_program"
          - tableName: "hiv_regimens"
          - tableName: "hiv_status"
          - tableName: "hiv_tests"
          - tableName: "hiv_viral_load"
          - tableName: "hiv_visit"
          - tableName: "ovc_program_encounters"
          - tableName: "pmtct_infant_delivery"
          - tableName: "pmtct_contacts"
          - tableName: "pmtct_visits"
          - tableName: "pmtct_labs"
          - tableName: "pmtct_pregnancy"
          - tableName: "tb_lab_results"
          - tableName: "tb_screening"          
          - tableName: "covid_admission"
          - tableName: "covid_diagnoses"
          - tableName: "covid_discharge"
          - tableName: "covid_disposition"
          - tableName: "covid_lab_test"
          - tableName: "covid_visit"
          - tableName: "echocardiogram_encounters"
          - tableName: "mch_birth"
          - tableName: "mch_delivery"
          - tableName: "mch_patient"
          - tableName: "mch_pregnancy"
          - tableName: "mch_status"
          - tableName: "mch_visit"
          - tableName: "mch_j9_data"
          - tableName: "summary_db_restore"
          - tableName: "vaccinations_anc"
          - tableName: "tb_lab_results"
          - tableName: "tb_screening"
          - tableName: "ncd_patient_table"
          - tableName: "ncd_heart_failure_patient"
          - tableName: "pathology_encounters"
          - tableName: "pathology_procedures"
          - tableName: "echo_summary_table"
          - tableName: "data_warnings"
          - tableName: "users"
          - tableName: "user_roles"
          - tableName: "user_logins"
            conditional: "select table_exists('authentication_event_log')"
          - tableName: "summary_db_restore"          
          
    - type: "job-pipeline"
      description: "Derive analysis tables"
      configuration:
        jobs:
          - type: "iterating-job"
            description: "Create static tables"
            configuration:
              jobTemplate:
                path: "create-derived-table-in-warehouse.yml"
              iterations:
                - tableName: "dim_date"
          - type: "iterating-job"
            description: "Create derived HIV tables"
            configuration:
              jobTemplate:
                path: "create-derived-table-in-warehouse.yml"
              iterations:
                - tableName: "hiv_monthly_reporting"
                - tableName: "hiv_patient_summary_status"
          - type: "iterating-job"
            description: "Create final derived tables"
            configuration:
              jobTemplate:
                path: "create-derived-table-in-warehouse.yml"
              iterations:
                - tableName: "visit_entry_dates"
                - tableName: "all_encounters_update"                
                - tableName: "update_index_numbers"                      
