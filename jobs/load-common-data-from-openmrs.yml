# Template that takes in the following parameters
# ${siteName}
# ${partitionNum}
# The purpose of this job is to refresh all of the DW table that are shared across multiple servers
type: "job-pipeline"
description: "Refreshing data for ${siteName} using partition ${partitionNum}"
parameters:
  conditional: ""
  incrementalEnabled: "false"
configuration:
  datasources:
    - "openmrs-${siteName}.yml"
  jobs:
    - path: "create-source-views-and-functions.yml"
    - path: "setup-for-incremental-updates.yml"
    - type: "iterating-job"
      description: "Importing from ${siteName} using partition ${partitionNum}"
      configuration:
        maxConcurrentJobs: 1
        jobTemplate:
          path: "import-to-table-partition.yml"
        iterations:
          - tableName: "all_lab_orders"
          - tableName: "all_lab_results"
          - tableName: "all_medication_prescribed"
          - tableName: "all_procedures"
          - tableName: "all_vitals"
          # - tableName: "all_encounters"
          #   incrementalEnabled: "true"
          - tableName: "all_visits"
          - tableName: "all_patients"
          - tableName: "covid_admission"
          - tableName: "covid_diagnoses"
          - tableName: "covid_discharge"
          - tableName: "covid_disposition"
          - tableName: "covid_lab_test"
          - tableName: "covid_visit"
          - tableName: "echocardiogram_encounters"
          - tableName: "mch_birth"
          - tableName: "mch_delivery"
          - tableName: "mch_diagnoses"
          - tableName: "mch_patient"
          - tableName: "mch_pregnancy"
          - tableName: "mch_status"
          - tableName: "mch_visit"
          - tableName: "mch_j9_data"
          - tableName: "summary_db_restore"
          - tableName: "vaccinations_anc"
          - tableName: "tb_lab_results"
          - tableName: "tb_screening"
          - tableName: "ncd_patient_table_staging"
          - tableName: "ncd_heart_failure_patient_staging"
          - tableName: "pathology_encounters"
          - tableName: "pathology_procedures"
          - tableName: "echo_summary_table"
          - tableName: "oncology_intake"
          - tableName: "oncology_treatment_plan"
          - tableName: "oncology_program"
          - tableName: "oncology_diagnosis"
          - tableName: "all_medication_dispensing"
            conditional: "select table_exists('medication_dispense')"
          - tableName: "data_warnings"
          - tableName: "users"
          - tableName: "user_roles"
          - tableName: "user_logins"
            conditional: "select table_exists('authentication_event_log')"
          - tableName: "mh_patients"
          - tableName: "mh_diagnosis"
          - tableName: "oncology_monthly_summary"
          - tableName: "mh_medications"
          - tableName: "mh_encounters"
          - tableName: "socioeconomic_encounter"
          - tableName: "all_diagnosis_past_year"
          - tableName: "all_encounters_past_year"
          - tableName: "ed_triage"
          - tableName: "outpatient_encounters"
