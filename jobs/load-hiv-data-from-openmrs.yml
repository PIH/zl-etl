type: "job-pipeline"
description: "Refresh HIV Data for ${siteName}"
parameters:
  conditional: ""
configuration:
  jobs:
    - path: "create-source-views-and-functions.yml"
    - type: "iterating-job"
      description: "Importing from ${dataset} to ${siteName} using partition ${partitionNum}"
      configuration:
        jobTemplate:
          path: "import-to-table-partition.yml"
        iterations:
          - tableName: "all_lab_orders"
          - tableName: "all_lab_results"
          - tableName: "all_vitals"
          - tableName: "all_visits"
          - tableName: "hiv_dispensing"
          - tableName: "hiv_patient"
          - tableName: "hiv_patient_program"
          - tableName: "hiv_regimens"
          - tableName: "hiv_status"
          - tableName: "hiv_tests"
          - tableName: "hiv_viral_load"
          - tableName: "hiv_visit"
          - tableName: "ovc_program_encounters"
          - tableName: "pmtct_infant_delivery"
          - tableName: "pmtct_contacts"
          - tableName: "pmtct_visits"
          - tableName: "pmtct_labs"
          - tableName: "pmtct_pregnancy"
          - tableName: "tb_lab_results"
          - tableName: "tb_screening"
          - tableName: "data_warnings"
          - tableName: "users"
          - tableName: "user_roles"
          - tableName: "user_logins"
          - tableName: "summary_db_restore"
            conditional: "select table_exists('authentication_event_log')"

    - type: "job-pipeline"
      description: "Derive HIV analysis tables"
      configuration:
        jobs:
          - type: "iterating-job"
            description: "Create static tables"
            configuration:
              jobTemplate:
                path: "create-derived-table-in-warehouse.yml"
              iterations:
                - tableName: "dim_date"
          - type: "iterating-job"
            description: "Create derived tables"
            configuration:
              jobTemplate:
                path: "create-derived-table-in-warehouse.yml"
              iterations:
                - tableName: "hiv_monthly_reporting"
                - tableName: "hiv_patient_summary_status"
