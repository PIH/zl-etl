type: "job-pipeline"
description: "Refresh HIV Data for ${siteName}"
parameters:
  conditional: ""
configuration:
  jobs:
    - path: "create-source-views-and-functions.yml"
    #- path: "setup-for-incremental-updates.yml"
    - type: "iterating-job"
      description: "Importing from ${dataset} to ${siteName} using partition ${partitionNum}"
      configuration:
        jobTemplate:
          path: "import-to-table-partition.yml"
        iterations:
          - tableName: "all_lab_orders"
          - tableName: "all_lab_results"
          - tableName: "all_medication_prescribed"
          - tableName: "all_vitals"
          #- tableName: "all_encounters"
          #  incrementalEnabled: "true"
          - tableName: "all_visits"
          - tableName: "eid_visit"
          - tableName: "hiv_dispensing"
          - tableName: "hiv_patient"
          - tableName: "hiv_patient_program"
          - tableName: "hiv_regimens"
          - tableName: "hiv_status"
          - tableName: "hiv_tests"
          - tableName: "hiv_viral_load"
          - tableName: "hiv_visit"
          - tableName: "ovc_program_encounters"
          - tableName: "pmtct_infant_delivery"
          - tableName: "pmtct_contacts"
          - tableName: "pmtct_visits"
          - tableName: "pmtct_labs"
          - tableName: "pmtct_pregnancy"
          - tableName: "tb_lab_results"
          - tableName: "tb_screening"
          - tableName: "data_warnings"
          - tableName: "users"
          - tableName: "user_roles"
          - tableName: "user_logins"
            conditional: "select table_exists('authentication_event_log')"
          - tableName: "summary_db_restore"
          
    # the following 2 jobs are to run these after the other hiv jobs are complete
    # these will be rerun after/if the entire pipeline runs
    # this is a temporary fix until we resolve issues in the pipeline 
    - type: "iterating-job"
      description: "Create derived setup tables"
      configuration:
        jobTemplate:
          path: "create-derived-table-in-warehouse.yml"
        iterations:
          - tableName: "update_index_numbers"
          - tableName: "dim_date"
          
    - type: "iterating-job"
      description: "Create final derived tables"
      configuration:
        jobTemplate:
          path: "create-derived-table-in-warehouse.yml"
        iterations:
          - tableName: "hiv_monthly_reporting"
          - tableName: "hiv_patient_summary_status"      
