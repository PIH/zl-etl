type: "job-pipeline"
description: "Refreshing ZL data"
schedule:
  cron: "${executeCron.refreshZlWarehouse}"
configuration:
  jobs:
    - type: "iterating-job"
      description: "Refreshing OpenMRS Data for all sites"
      configuration:
        maxConcurrentJobs: 5  # Import into up to 5 sites concurrently
        errorHandling:
          maxAttempts: 3
          retryInterval: 60
          retryIntervalUnit: "MINUTES"
        iterations:
          - siteName: "cange"
            partitionNum: "1"
            dataset: "common-data"
          - siteName: "hinche"
            partitionNum: "2"
            dataset: "common-data"
          - siteName: "saint_marc_hsn"
            partitionNum: "3"
            dataset: "common-data"
          - siteName: "lacolline"
            partitionNum: "4"
            dataset: "common-data"
          - siteName: "thomonde"
            partitionNum: "5"
            dataset: "common-data"
          - siteName: "mirebalais"
            partitionNum: "6"
            dataset: "common-data"
          - siteName: "hiv"
            partitionNum: "8"
            dataset: "hiv-data"
        jobTemplate:
          path: "load-${dataset}-from-openmrs.yml"

    - type: "iterating-job"
      description: "Create final derived tables"
      configuration:
        jobTemplate:
          path: "create-derived-table-in-warehouse.yml"
        iterations:
          - tableName: "visit_entry_dates"
          - tableName: "all_encounters_update"
          - tableName: "update_index_numbers"    
          
    - type: "sql-execution"
      description: "Update petl_load_times table for Cange"
      configuration:
        datasource: "openmrs-cange.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"
    - type: "sql-execution"
      description: "Update petl_load_times table for Hinche"
      configuration:
        datasource: "openmrs-hinche.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"          
    - type: "sql-execution"
      description: "Update petl_load_times table for Saint_marc_hsn"
      configuration:
        datasource: "openmrs-saint_marc_hsn.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"
    - type: "sql-execution"
      description: "Update petl_load_times table for Lacolline"
      configuration:
        datasource: "openmrs-lacolline.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"       
    - type: "sql-execution"
      description: "Update petl_load_times table for Thomonde"
      configuration:
        datasource: "openmrs-thomonde.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"  
    - type: "sql-execution"
      description: "Update petl_load_times table for Mirebalais"
      configuration:
        datasource: "openmrs-mirebalais.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"  
    - type: "sql-execution"
      description: "Update petl_load_times table for HIV"
      configuration:
        datasource: "openmrs-hiv.yml"
        scripts: 
          -"sql/extractions/update_petl_load_times.sql"  
